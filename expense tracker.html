<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker</title>
    
    <!-- Using tailwind for fast css -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React libraries -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { background-color: #f0f2f5; font-family: sans-serif; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel" data-type="module">
        // Importing firebase stuff
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, deleteDoc, doc, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        // --- PASTE FIREBASE KEYS HERE ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456:web:123456"
        };
        // --------------------------------

        // init firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const { useState, useEffect } = React;

        function App() {
            // state variables
            const [user, setUser] = useState(null);
            const [myList, setMyList] = useState([]); 
            const [loading, setLoading] = useState(true);

            // form values
            const [txt, setTxt] = useState('');
            const [val, setVal] = useState('');
            const [kind, setKind] = useState('expense');
            const [tag, setTag] = useState('food');
            
            // login name
            const [uName, setUName] = useState('');
            const [busy, setBusy] = useState(false);

            // check user login
            useEffect(() => {
                // console.log("app started");
                onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    setLoading(false);
                });
            }, []);

            // get data from db
            useEffect(() => {
                if (user) {
                    // console.log("fetching...");
                    const q = query(collection(db, 'users', user.uid, 'transactions'), orderBy('createdAt', 'desc'));
                    
                    const unsub = onSnapshot(q, (snap) => {
                        var tempArr = [];
                        snap.forEach(d => {
                            let obj = d.data();
                            obj.id = d.id;
                            tempArr.push(obj);
                        });
                        setMyList(tempArr);
                    });
                    
                    // cleanup
                    return () => unsub();
                }
            }, [user]);

            // login function
            const doLogin = async (e) => {
                e.preventDefault();
                if(uName == '') {
                    alert("Name pls");
                    return;
                }
                setBusy(true);
                try {
                    // using anon login cuz its easier
                    const res = await signInAnonymously(auth);
                    await updateProfile(res.user, { displayName: uName });
                } catch(err) {
                    console.log("login error", err);
                }
                setBusy(false);
            };

            // add button click
            const submitData = async (e) => {
                e.preventDefault();
                
                // simple validation
                if(!txt || !val) {
                    alert("Fill everything!");
                    return;
                }
                
                // change category if income
                var finalCat = tag;
                if(kind == 'income') {
                    finalCat = 'Salary';
                }
                
                try {
                    await addDoc(collection(db, 'users', user.uid, 'transactions'), {
                        description: txt,
                        amount: Number(val),
                        type: kind,
                        category: finalCat,
                        createdAt: serverTimestamp()
                    });
                    // clear inputs
                    setTxt(''); 
                    setVal('');
                } catch(e) {
                    console.log(e);
                }
            };

            const remove = async (id) => {
                if(confirm("Delete this?")) {
                    await deleteDoc(doc(db, 'users', user.uid, 'transactions', id));
                }
            };

            // manual math
            var moneyIn = 0;
            var moneyOut = 0;
            var chartObj = {};

            // loop for calculations
            for(var i=0; i<myList.length; i++) {
                let item = myList[i];
                let num = parseFloat(item.amount);

                if(item.type == 'income') {
                    moneyIn = moneyIn + num;
                } else {
                    moneyOut = moneyOut + num;
                    
                    // count categories for chart
                    if(chartObj[item.category]) {
                        chartObj[item.category] += num;
                    } else {
                        chartObj[item.category] = num;
                    }
                }
            }
            
            let total = moneyIn - moneyOut;

            if(loading) return <div style={{padding: 50}}>Loading...</div>;

            // show login screen if no user
            if(!user) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="bg-white p-8 rounded shadow-lg w-80">
                            <h2 className="text-xl font-bold mb-4 text-center">Expense Tracker</h2>
                            <form onSubmit={doLogin}>
                                <input 
                                    className="w-full border p-2 mb-4 rounded" 
                                    placeholder="Enter Name" 
                                    value={uName} 
                                    onChange={e=>setUName(e.target.value)} 
                                />
                                <button className="w-full bg-blue-500 text-white p-2 rounded">
                                    {busy ? 'Wait...' : 'Enter'}
                                </button>
                            </form>
                        </div>
                    </div>
                );
            }

            // main dashboard
            return (
                <div className="min-h-screen flex flex-col md:flex-row">
                    
                    {/* Left Panel */}
                    <div className="md:w-64 bg-white border-r p-5">
                        <h1 className="text-xl font-bold text-blue-600 mb-6">Wallet App</h1>
                        <p className="mb-4 text-sm">Hello, <b>{user.displayName}</b></p>
                        <button onClick={()=>signOut(auth)} className="text-red-500 text-sm">Logout</button>
                    </div>

                    {/* Right Panel */}
                    <div className="flex-1 p-5 md:p-10">
                        <h2 className="text-2xl font-bold mb-6">My Dashboard</h2>
                        
                        {/* 3 Stats Boxes */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                            <div className="card border-l-4 border-blue-500">
                                <div className="text-gray-500 text-xs">Total Balance</div>
                                <div className="text-2xl font-bold">${total}</div>
                            </div>
                            <div className="card border-l-4 border-green-500">
                                <div className="text-gray-500 text-xs">Income</div>
                                <div className="text-2xl font-bold text-green-600">${moneyIn}</div>
                            </div>
                            <div className="card border-l-4 border-red-500">
                                <div className="text-gray-500 text-xs">Expenses</div>
                                <div className="text-2xl font-bold text-red-600">${moneyOut}</div>
                            </div>
                        </div>

                        <div className="flex flex-col lg:flex-row gap-8">
                            
                            <div className="lg:w-2/3">
                                {/* Input Form */}
                                <div className="card mb-5">
                                    <h3 className="font-bold mb-3">Add New</h3>
                                    <form onSubmit={submitData}>
                                        <div className="flex gap-2 mb-2">
                                            <input 
                                                className="border p-2 rounded w-full" 
                                                placeholder="Description" 
                                                value={txt} 
                                                onChange={e=>setTxt(e.target.value)} 
                                            />
                                            <input 
                                                className="border p-2 rounded w-24" 
                                                placeholder="0.00" 
                                                type="number" 
                                                value={val} 
                                                onChange={e=>setVal(e.target.value)} 
                                            />
                                        </div>
                                        <div className="flex gap-2">
                                            <select className="border p-2 rounded" value={kind} onChange={e=>setKind(e.target.value)}>
                                                <option value="expense">Expense</option>
                                                <option value="income">Income</option>
                                            </select>
                                            
                                            {/* show categories only if expense */}
                                            {kind == 'expense' && (
                                                <select className="border p-2 rounded" value={tag} onChange={e=>setTag(e.target.value)}>
                                                    <option value="food">Food</option>
                                                    <option value="travel">Travel</option>
                                                    <option value="bills">Bills</option>
                                                    <option value="other">Other</option>
                                                </select>
                                            )}
                                            
                                            <button className="bg-blue-600 text-white px-4 rounded ml-auto">Save</button>
                                        </div>
                                    </form>
                                </div>

                                {/* List of items */}
                                <div className="card">
                                    <h3 className="font-bold mb-3">History</h3>
                                    <div style={{ maxHeight: '300px', overflowY: 'auto' }}>
                                        {myList.length == 0 ? <p className="text-gray-400 text-sm">Empty list.</p> : null}
                                        
                                        {myList.map((item, index) => (
                                            // using index key which is bad practice but common for students
                                            <div key={index} className="flex justify-between items-center border-b py-2">
                                                <div>
                                                    <div className="font-medium">{item.description}</div>
                                                    <div className="text-xs text-gray-500">{item.category}</div>
                                                </div>
                                                <div className="flex items-center gap-3">
                                                    <span className={item.type == 'income' ? 'text-green-600 font-bold' : 'font-bold'}>
                                                        {item.type == 'income' ? '+' : '-'}${item.amount}
                                                    </span>
                                                    <button onClick={()=>remove(item.id)} className="text-gray-300 hover:text-red-500">x</button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            {/* Simple Bar Chart */}
                            <div className="lg:w-1/3 card">
                                <h3 className="font-bold mb-4">Stats</h3>
                                
                                {Object.keys(chartObj).length > 0 ? (
                                    <div>
                                        {Object.keys(chartObj).map(k => {
                                            let pct = (chartObj[k] / moneyOut) * 100;
                                            return (
                                                <div key={k} className="mb-3">
                                                    <div className="flex justify-between text-sm mb-1">
                                                        <span className="capitalize">{k}</span>
                                                        <span>{Math.round(pct)}%</span>
                                                    </div>
                                                    <div className="w-full bg-gray-200 h-2 rounded-full">
                                                        <div className="bg-blue-500 h-2 rounded-full" style={{width: `${pct}%`}}></div>
                                                    </div>
                                                </div>
                                            )
                                        })}
                                    </div>
                                ) : (
                                    <p className="text-gray-400 text-sm">Add expenses to see this.</p>
                                )}
                            </div>

                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
